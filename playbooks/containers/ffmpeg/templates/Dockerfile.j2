# FFmpeg + Node.js環境
FROM jrottenberg/ffmpeg:latest

# Node.jsとpnpmのインストール
RUN apt-get update && \
    apt-get install -y curl ca-certificates gnupg && \
    curl -fsSL https://deb.nodesource.com/setup_{{ docker_container_node_version }}.x | bash - && \
    apt-get install -y nodejs && \
    npm install -g pnpm tsx && \
    apt-get autoremove -y && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# タイムゾーン設定
ENV TZ={{ docker_container_timezone }}
RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone

# ワーキングディレクトリを設定（ボリュームマウントされないディレクトリを使用）
WORKDIR /root

# エントリーポイントをリセット（jrottenberg/ffmpegのENTRYPOINTを上書き）
ENTRYPOINT []

# ワーカー起動スクリプトをコピー
COPY worker-entrypoint.sh /worker-entrypoint.sh
RUN chmod +x /worker-entrypoint.sh

# ワーカープロセスを自動起動
CMD ["/worker-entrypoint.sh"]
