# FFmpeg + Node.js環境
FROM jrottenberg/ffmpeg:latest AS ffmpeg-base

# Node.jsとpnpmのインストール
FROM node:{{ docker_container_node_version }}-alpine

# FFmpegをベースイメージからコピー
COPY --from=ffmpeg-base /usr/local/bin/ffmpeg /usr/local/bin/ffmpeg
COPY --from=ffmpeg-base /usr/local/bin/ffprobe /usr/local/bin/ffprobe

# 必要なライブラリをインストール
RUN apk add --no-cache \
    libgomp \
    libstdc++ \
    ca-certificates \
    tzdata

# タイムゾーン設定
ENV TZ={{ docker_container_timezone }}

# pnpmのインストール
RUN npm install -g pnpm tsx

# ワーキングディレクトリの作成
WORKDIR /app

# ディレクトリを作成（必要に応じて）
RUN mkdir -p /app/packages

# エントリーポイント（後でワーカースクリプトを起動）
CMD ["tail", "-f", "/dev/null"]
